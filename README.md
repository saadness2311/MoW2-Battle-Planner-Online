# MoW Battle Planner Online

Многопользовательский пошаговый планировщик боёв на базе **Next.js 14 + Phaser 3 + Supabase** с деплоем на Vercel. Проект переписан с офлайн-версии MoW Battle Planner и поддерживает синхронизацию комнат, карты и чата в реальном времени.

## Возможности

- Авторизация/регистрация по никнейму и паролю (ник ≥ 3 символов, пароль ≥ 1 символ) через форму `/auth`. Данные хранятся в таблице `users`, никнейм уникален.
- Лобби со списком комнат, опциональными паролями и ограничением до 50 игроков. Создатель может удалять комнату и блокировать вход.
- Внутри комнаты: три эшелона, копирование состояния в следующий эшелон, пошаговый режим и единственный редактор карты.
- Совместная карта на Phaser: юниты, символы, линии фронта и зоны противника синхронизируются через Supabase. Перемещения и размещения ограничены по частоте.
- Чат комнаты с лимитом 1 сообщение/сек и realtime-обновлением.
- Локальное сохранение/загрузка плана в JSON, экспорт PNG через браузерные средства, независимое управление камерой.
- Каталог полковых иконок USSR/Germany/USA берёт файлы из `public/assets`, выбор слота 1–10 подготавливает нужную иконку и подсветку команды.

## Запуск локально

1. Установите зависимости:

   ```bash
   npm install
   ```

2. Создайте `.env.local` в корне и добавьте ключи вашего проекта Supabase:

   ```env
   NEXT_PUBLIC_SUPABASE_URL=https://<project>.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=<anon-key>
   ```

3. В Supabase выполните SQL из [`supabase_schema.sql`](./supabase_schema.sql) через SQL Editor (обеспечьте включенный pgcrypto).

4. Ассеты карт и символов уже лежат в `public/assets` (maps, symbols, ussr, germany, usa). При необходимости замените свои файлы в этих папках.

5. Запустите dev-сервер:

   ```bash
   npm run dev
   ```

6. Откройте `http://localhost:3000`.

## Деплой на Vercel

1. Импортируйте репозиторий в Vercel и выберите шаблон **Next.js**.
2. В настройках проекта добавьте переменные окружения `NEXT_PUBLIC_SUPABASE_URL` и `NEXT_PUBLIC_SUPABASE_ANON_KEY`.
3. Задеплойте. Realtime Supabase работает из браузера, отдельные серверные функции не требуются.

## Структура Supabase

- `users`: хранение никнейма и SHA-256 хеша пароля.
- `rooms`: владелец, имя, опциональный пароль (hash), текущий ход, выбранная карта.
- `room_players`: участники комнаты с отметками времени и флагом присутствия.
- `units`/`symbols`/`drawings`: данные карты по эшелонам.
- `logs`: вспомогательные записи действий.

Полный DDL — в [`supabase_schema.sql`](./supabase_schema.sql).

## Как работать в приложении

1. На `/auth` создайте аккаунт или войдите (ник ≥ 3 символов, пароль ≥ 1 символ). Сессия сохраняется в `localStorage`.
2. На `/lobby` или `/rooms` создайте комнату (опциональный пароль) или войдите в существующую. Создатель автоматически становится владельцем хода.
3. В комнате:
   - Верхняя панель: управление ходом, назначение редактора, блокировка входа.
   - Справа — чат.
   - Слева — выбор карты (25 карт + альтернативы), каталог символов, выбор слота юнита (1–5 синие, 6–10 красные), инструменты фронта/очистки, сохранение/загрузка плана и копирование эшелона.
   - По центру Phaser-слой: камера перемещается локально. Только игрок с ходом **и** назначенный редактор может размещать/двигать символы и рисовать. Перемещения ограничены 1/сек, размещения — 5/сек.
4. Сохранение плана: кнопка «Сохранить план (JSON)» в сайдбаре; загрузка — через выбор файла JSON.

## Оптимизация Realtime

- Канал комнаты подписан на `rooms`, `room_users`, `room_permissions`, `room_units`, `room_drawings`, `chat_messages`.
- Клиент сглаживает нагрузку: на карту отправляется только финальная позиция перетаскивания; камера не синхронизируется.
- Частота действий ограничена на клиенте (перемещения/символы/чат).

## Структура проекта

- `app/` — страницы Next.js (`/auth`, `/lobby`, `/rooms`, `/room/[id]`).
- `components/` — UI и контейнеры (PhaserGame, панели комнаты, чат, план сохранения).
- `phaser/` — сцена карты и логика синхронизации.
- `lib/` — supabase client, auth-утилиты, работа с комнатами и планами.
- `assets/` — базовые изображения символов и карт (можно заменить своими).

## Пошаговая логика

- Создатель комнаты управляет ходом и назначает единственного редактора (`editing_user_id`).
- Управление картой разрешено владельцу или игроку, который одновременно является текущим ходящим и назначенным редактором.
- Эшелоны переключаются локально, копирование переносит юниты/символы/рисунки в следующий слот.
- Каждое действие отправляет запись в Supabase и обновляется через Realtime для всех подключённых клиентов.

## Скрипты

- `npm run dev` — локальная разработка.
- `npm run build` — сборка.
- `npm run start` — продакшн-сервер.

