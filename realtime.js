/* realtime.js
   –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è:
   - –ë–µ–∑ –Ω–∏–∫–Ω–µ–π–º–æ–≤ –≤–æ–æ–±—â–µ
   - –ú–µ–Ω—é –∫–æ–º–Ω–∞—Ç –º–æ–∂–Ω–æ —Å–≤–µ—Ä–Ω—É—Ç—å –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω
*/
(function(){
  function el(id){return document.getElementById(id);}
  function nowTs(){return Date.now();}
  const ROOMS_KEY = 'mow2_rooms_v1';

  function loadRooms(){
    try{
      const raw = localStorage.getItem(ROOMS_KEY);
      return raw ? JSON.parse(raw) : {};
    }catch(e){return {};}
  }
  function saveRooms(obj){ localStorage.setItem(ROOMS_KEY, JSON.stringify(obj)); }

  function escapeHtml(s){
    return (s+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderRooms(){
    const listDiv = el('rooms-list');
    const rooms = loadRooms();
    listDiv.innerHTML = '';
    const names = Object.keys(rooms).sort();
    if(names.length===0){
      listDiv.innerHTML = '<div style="color:#666">–ö–æ–º–Ω–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç</div>';
      return;
    }
    names.forEach(name=>{
      const r = rooms[name];
      const row = document.createElement('div');
      row.style.padding='6px 0';
      row.style.borderBottom='1px solid #eee';
      row.innerHTML = '<strong>'+escapeHtml(name)+'</strong> ‚Äî ' + (r.count||0) + ' –∏–≥—Ä–æ–∫–æ–≤ ' + (r.pass ? 'üîí' : '');
      const joinBtn = document.createElement('button');
      joinBtn.textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è';
      joinBtn.style.marginLeft='8px';
      joinBtn.onclick = ()=>{ promptJoin(name); };
      row.appendChild(joinBtn);
      listDiv.appendChild(row);
    });
  }

  function promptJoin(name){
    const rooms = loadRooms();
    const r = rooms[name];
    if(!r){ alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); renderRooms(); return; }
    if(r.pass){
      const p = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã "'+name+'":');
      if(p===null) return;
      if(p !== r.pass){
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        return;
      }
    }
    const roomLink = location.origin + location.pathname + '#room=' + encodeURIComponent(r.id);
    location.href = roomLink;
  }

  
function createRoom(name, pass){
    const rooms = loadRooms();
    if(!name || !name.trim()) throw new Error('empty-name');
    if(rooms[name]) throw new Error('name-exists');
    const id = 'r' + Math.random().toString(36).slice(2,10);
    rooms[name] = { id: id, name: name, pass: pass || '', created: nowTs(), count: 0 };
    saveRooms(rooms);

    // Try to broadcast via TogetherJS hub without starting TogetherJS UI.
    try {
      if (typeof TogetherJS !== 'undefined' && TogetherJS.hub && TogetherJS.hub.emit) {
        TogetherJS.hub.emit("announce-room", { room: rooms[name] });
      } else if (typeof TogetherJS !== 'undefined' && TogetherJS.running) {
        TogetherJS.send({ type: 'announce-room', room: rooms[name] });
      }
    } catch(e) {
      console.error('announce-room emit failed', e);
    }

    return rooms[name];
  }


  function updateCountForRoomId(roomId, delta){
    const rooms = loadRooms();
    let changed=false;
    for(const name in rooms){
      if(rooms[name].id === roomId){
        rooms[name].count = Math.max(0, (rooms[name].count||0) + delta);
        changed=true;
      }
    }
    if(changed) saveRooms(rooms);
  }

  document.addEventListener('DOMContentLoaded', function(){
    // TogetherJS hub listener to receive announce-room from other pages (no UI start).
    try {
      if (typeof TogetherJS !== 'undefined' && TogetherJS.hub && TogetherJS.hub.on) {
        TogetherJS.hub.on("announce-room", function(data) {
          try {
            if (!data || !data.room) return;
            const rooms = loadRooms();
            if (!rooms[data.room.name]) {
              rooms[data.room.name] = data.room;
              saveRooms(rooms);
              renderRooms();
            }
          } catch(e) { console.error('announce-room handler', e); }
        });
      }
    } catch(e) { console.error('TogetherJS hub setup', e); }

    const btnShow = el('btn-show-create');
    const createForm = el('create-form');
    const btnCancel = el('btn-cancel-create');
    const btnCreate = el('btn-create-room');
    const roomLinkDiv = el('room-link');
    const createError = el('create-error');
    const overlay = el('rooms-overlay');

    // üß© –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –º–µ–Ω—é –∫–æ–º–Ω–∞—Ç
    const toggleBtn = document.createElement('button');
    toggleBtn.id = 'rooms-toggle';
    toggleBtn.textContent = '–ö–æ–º–Ω–∞—Ç—ã ‚§¢';
    Object.assign(toggleBtn.style, {
      position: 'fixed',
      top: '10px',
      left: '10px',
      zIndex: 9999,
      display: 'none',
      padding: '6px 10px',
      borderRadius: '8px',
      border: '1px solid #888',
      background: '#fff',
      cursor: 'pointer',
      fontSize: '14px'
    });
    document.body.appendChild(toggleBtn);

    let overlayVisible = true;
    toggleBtn.onclick = ()=>{
      overlayVisible = !overlayVisible;
      overlay.style.display = overlayVisible ? 'block' : 'none';
    };

    btnShow.onclick = ()=>{
      createForm.style.display='block';
      btnShow.style.display='none';
    };
    btnCancel.onclick = ()=>{
      createForm.style.display='none';
      btnShow.style.display='inline-block';
      roomLinkDiv.style.display='none';
      createError.innerText='';
    };

    btnCreate.onclick = ()=>{
      createError.innerText = '';
      const name = el('room-name').value.trim();
      const pass = el('room-pass').value;
      try{
        const roomObj = createRoom(name, pass);
        const link = location.origin + location.pathname + '#room=' + encodeURIComponent(roomObj.id);
        roomLinkDiv.innerHTML = '<div>–°—Å—ã–ª–∫–∞: <a href="'+link+'">'+link+'</a></div>';
        roomLinkDiv.style.display='block';
        startTogether(roomObj.id);
      }catch(e){
        if(e.message === 'empty-name') createError.innerText = '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
        else if(e.message === 'name-exists') createError.innerText = '–ö–æ–º–Ω–∞—Ç–∞ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
        else createError.innerText = '–û—à–∏–±–∫–∞: ' + e.message;
      }
      renderRooms();
    };

    renderRooms();
    setInterval(renderRooms, 5000);

    function parseHash(){
      const h = location.hash.substring(1);
      const params = {};
      h.split('&').forEach(part=>{
        const kv = part.split('=');
        if(kv[0]) params[kv[0]] = decodeURIComponent((kv[1]||''));
      });
      return params;
    }

    const params = parseHash();
    if(params.room){ startTogether(params.room); }

    window.startTogether = function(roomId){
      if(!window.TogetherJS){
        alert('TogetherJS –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.');
        return;
      }

      TogetherJS.config_getUserName = () => '–ò–≥—Ä–æ–∫';
      TogetherJS();

      TogetherJS.on("ready", function () {
        // —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∫–æ–º–Ω–∞—Ç
        overlay.style.display = 'none';
        toggleBtn.style.display = 'block';
        overlayVisible = false;

        updateCountForRoomId(roomId, 1);
        renderRooms();

        const roomsObj = loadRooms();
        for(const nm in roomsObj){
          TogetherJS.send({type:'announce-room', room: roomsObj[nm]});
        }
        TogetherJS.send({type:'presence','roomId':roomId});
      });

      TogetherJS.on("close", function () {
        overlay.style.display = 'block';
        toggleBtn.style.display = 'none';
        overlayVisible = true;
        const pr = parseHash();
        if(pr.room) updateCountForRoomId(pr.room, -1);
        renderRooms();
      });

      TogetherJS.hub.on("togetherjs.msg", function (msg) {
        try{
          const data = msg.msg;
          if(!data || !data.type) return;
          if(data.type === 'announce-room'){
            const rooms = loadRooms();
            if(!rooms[data.room.name]){
              rooms[data.room.name] = data.room;
              saveRooms(rooms);
              renderRooms();
            }
          }else if(data.type === 'map-action'){
            const ev = new CustomEvent('realtime-map-action', {detail: data});
            window.dispatchEvent(ev);
          }else if(data.type === 'presence'){
            if(data.roomId){
              updateCountForRoomId(data.roomId, 1);
              renderRooms();
            }
          }
        }catch(e){ console.error(e); }
      });

      window.sendMapAction = function(action){
        action._ts = nowTs();
        if(window.TogetherJS && TogetherJS.running){
          TogetherJS.send({type:'map-action', action: action});
        }
      };
    };

    window.addEventListener('storage', function(e){
      if(e.key === ROOMS_KEY) renderRooms();
    });

  });
})();
