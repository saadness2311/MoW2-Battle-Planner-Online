/* realtime.js
 Client-side "magic link" rooms using TogetherJS.
 - Creates rooms by generating an id and sharing a link with #room=<id>&nick=<nick>
 - Stores room metadata in localStorage and announces via TogetherJS when connected
 - Rooms list auto-updates from localStorage every 5 seconds and on TogetherJS announcements
 - Passwords are stored client-side (localStorage). This is a "super-simple" solution without servers.
 - Conflict resolution: "last-wins" ‚Äî every action carries a timestamp and is applied if newer.
 - Integrates with existing script.js by sending/receiving 'map-action' messages that include action details.
*/
(function(){
  function el(id){return document.getElementById(id);}
  function qs(sel){return document.querySelector(sel);}
  function nowTs(){return Date.now();}
  const ROOMS_KEY = 'mow2_rooms_v1';

  function loadRooms(){
    try{
      const raw = localStorage.getItem(ROOMS_KEY);
      if(!raw) return {};
      return JSON.parse(raw);
    }catch(e){return {};}
  }
  function saveRooms(obj){
    localStorage.setItem(ROOMS_KEY, JSON.stringify(obj));
  }

  function renderRooms(){
    const listDiv = el('rooms-list');
    const rooms = loadRooms();
    listDiv.innerHTML = '';
    const names = Object.keys(rooms).sort();
    if(names.length===0){ listDiv.innerHTML = '<div style="color:#666">–ö–æ–º–Ω–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
    names.forEach(name=>{
      const r = rooms[name];
      const row = document.createElement('div');
      row.style.padding='6px 0';
      row.style.borderBottom='1px solid #eee';
      row.innerHTML = '<strong>'+escapeHtml(name)+'</strong> ‚Äî ' + (r.count||0) + ' –∏–≥—Ä–æ–∫–æ–≤ ' + (r.pass ? 'üîí' : ''); 
      const joinBtn = document.createElement('button');
      joinBtn.textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è';
      joinBtn.style.marginLeft='8px';
      joinBtn.onclick = ()=>{ promptJoin(name); };
      row.appendChild(joinBtn);
      listDiv.appendChild(row);
    });
  }

  function escapeHtml(s){ return (s+'').replace(/[&<>"\']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

  function promptJoin(name){
    const rooms = loadRooms();
    const r = rooms[name];
    if(!r){ alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); renderRooms(); return; }
    if(r.pass){
      const p = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã "'+name+'":');
      if(p===null) return;
      if(p !== r.pass){
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        return;
      }
    }
    const nick = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º:', localStorage.getItem('mow2_nick')||'–ò–≥—Ä–æ–∫');
    if(!nick) return;
    localStorage.setItem('mow2_nick', nick);
    const roomLink = location.origin + location.pathname + '#room=' + encodeURIComponent(r.id) + '&nick=' + encodeURIComponent(nick);
    location.href = roomLink;
  }

  function createRoom(name, pass, nick){
    const rooms = loadRooms();
    if(!name || !name.trim()) { throw new Error('empty-name'); }
    if(rooms[name]) { throw new Error('name-exists'); }
    const id = 'r' + Math.random().toString(36).slice(2,10);
    rooms[name] = { id: id, name: name, pass: pass || '', created: nowTs(), count: 0 };
    saveRooms(rooms);
    localStorage.setItem('mow2_nick', nick||'–ò–≥—Ä–æ–∫');
    if(window.TogetherJS && TogetherJS.running){
      TogetherJS.send({type:'announce-room', room: rooms[name]});
    }
    return rooms[name];
  }

  function announceRoomToConnected(roomObj){
    if(window.TogetherJS && TogetherJS.running){
      TogetherJS.send({type:'announce-room', room: roomObj});
    }
  }

  function updateCountForRoomId(roomId, delta){
    const rooms = loadRooms();
    let changed=false;
    for(const name in rooms){
      if(rooms[name].id === roomId){
        rooms[name].count = Math.max(0, (rooms[name].count||0) + delta);
        changed=true;
      }
    }
    if(changed) saveRooms(rooms);
  }

  document.addEventListener('DOMContentLoaded', function(){
    const btnShow = el('btn-show-create');
    const createForm = el('create-form');
    const btnCancel = el('btn-cancel-create');
    const btnCreate = el('btn-create-room');
    const roomLinkDiv = el('room-link');
    const createError = el('create-error');

    btnShow.onclick = ()=>{ createForm.style.display='block'; btnShow.style.display='none'; };
    btnCancel.onclick = ()=>{ createForm.style.display='none'; btnShow.style.display='inline-block'; roomLinkDiv.style.display='none'; createError.innerText=''; };

    btnCreate.onclick = ()=>{
      createError.innerText = '';
      const name = el('room-name').value.trim();
      const pass = el('room-pass').value;
      const nick = el('nick-name').value.trim() || localStorage.getItem('mow2_nick') || '–ò–≥—Ä–æ–∫';
      try{
        const roomObj = createRoom(name, pass, nick);
        const link = location.origin + location.pathname + '#room=' + encodeURIComponent(roomObj.id) + '&nick=' + encodeURIComponent(nick);
        roomLinkDiv.innerHTML = '<div>–°—Å—ã–ª–∫–∞: <a href="'+link+'">'+link+'</a></div>';
        roomLinkDiv.style.display='block';
        startTogether(roomObj.id);
      }catch(e){
        if(e.message === 'empty-name') createError.innerText = '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
        else if(e.message === 'name-exists') createError.innerText = '–ö–æ–º–Ω–∞—Ç–∞ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
        else createError.innerText = '–û—à–∏–±–∫–∞: ' + e.message;
      }
      renderRooms();
    };

    renderRooms();
    setInterval(renderRooms, 5000);

    function parseHash(){
      const h = location.hash.substring(1);
      const params = {};
      h.split('&').forEach(part=>{
        const kv = part.split('=');
        if(kv[0]) params[kv[0]] = decodeURIComponent((kv[1]||''));
      });
      return params;
    }

    const params = parseHash();
    if(params.room){
      if(params.nick) localStorage.setItem('mow2_nick', params.nick);
      startTogether(params.room);
    }

    if(window.TogetherJS){}

    window.startTogether = function(roomId){
      if(!window.TogetherJS){
        alert('TogetherJS script –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        return;
      }
      TogetherJS.config_getUserName = function () {
        return localStorage.getItem('mow2_nick') || '–ò–≥—Ä–æ–∫';
      };
      TogetherJS();

      TogetherJS.on("ready", function () {
        // üîπ –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        const overlay = document.getElementById('rooms-overlay');
        if (overlay) overlay.style.display = 'none';

        updateCountForRoomId(roomId, 1);
        renderRooms();
        const roomsObj = loadRooms();
        for(const nm in roomsObj){
          TogetherJS.send({type:'announce-room', room: roomsObj[nm]});
        }
        TogetherJS.send({type:'presence','roomId':roomId});
      });

      TogetherJS.on("close", function () {
        // üîπ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –æ–±—Ä–∞—Ç–Ω–æ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
        const overlay = document.getElementById('rooms-overlay');
        if (overlay) overlay.style.display = 'block';

        const pr = parseHash();
        if(pr.room) updateCountForRoomId(pr.room, -1);
        renderRooms();
      });

      TogetherJS.hub.on("togetherjs.msg", function (msg) {
        try{
          const data = msg.msg;
          if(!data || !data.type) return;
          if(data.type === 'announce-room'){
            const rooms = loadRooms();
            if(!rooms[data.room.name]){
              rooms[data.room.name] = data.room;
              saveRooms(rooms);
              renderRooms();
            }
          }else if(data.type === 'map-action'){
            const ev = new CustomEvent('realtime-map-action', {detail: data});
            window.dispatchEvent(ev);
          }else if(data.type === 'presence'){
            if(data.roomId){
              updateCountForRoomId(data.roomId, 1);
              renderRooms();
            }
          }
        }catch(e){ console.error(e); }
      });

      window.sendMapAction = function(action){
        action._ts = nowTs();
        action._from = localStorage.getItem('mow2_nick') || '–ò–≥—Ä–æ–∫';
        if(window.TogetherJS && TogetherJS.running){
          TogetherJS.send({type:'map-action', action: action});
        }
      };
    };

    window.addEventListener('storage', function(e){
      if(e.key === ROOMS_KEY){
        renderRooms();
      }
    });

  });
})();
